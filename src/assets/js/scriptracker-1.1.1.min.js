!function e(t,s,r){function n(o,i){if(!s[o]){if(!t[o]){var l="function"==typeof require&&require;if(!i&&l)return l(o,!0);if(a)return a(o,!0);throw new Error("Cannot find module '"+o+"'")}var p=s[o]={exports:{}};t[o][0].call(p.exports,function(e){var s=t[o][1][e];return n(s?s:e)},p,p.exports,e,t,s,r)}return s[o].exports}for(var a="function"==typeof require&&require,o=0;o<r.length;o++)n(r[o]);return n}({1:[function(e,t,s){"use strict";var r=function(){this.instrument=0,this.sample={sample:null,position:0,restart:0,step:0,remain:0,reversed:!1},this.volume={channelVolume:0,sampleVolume:0,volumeSlide:0,envelope:null},this.panning={pan:.5,panSlide:0,envelope:null},this.porta={notePeriod:0,step:0},this.vibrato={position:0,step:0,amplitude:0},this.tremolo={position:0,step:0,amplitude:0,volume:1},this.tremor={onCount:0,offCount:0,muted:!1},this.isMuted=!1,this.note=0,this.period=0,this.noteDelay=0,this.loopMark=0,this.loopCount=0,this.tremorCount=0,this.envelopePos=0,this.noteReleased=!1};r.prototype.reset=function(){this.sample.sample=null,this.sample.position=0,this.sample.restart=0,this.sample.step=0,this.sample.remain=0,this.sample.reversed=!1,this.volume.channelVolume=0,this.volume.sampleVolume=0,this.volume.volumeSlide=0,this.volume.envelope=null,this.panning.pan=.5,this.panning.panSlide=0,this.panning.envelope=null,this.porta.notePeriod=0,this.porta.step=0,this.vibrato.position=0,this.vibrato.step=0,this.vibrato.amplitude=0,this.tremolo.position=0,this.tremolo.step=0,this.tremolo.amplitude=0,this.tremolo.volume=1,this.tremor.onCount=0,this.tremor.offCount=0,this.tremor.muted=!1,this.isMuted=!1,this.tremorMute=!1,this.note=0,this.period=0,this.noteDelay=0,this.loopMark=0,this.loopCount=0,this.envelopePos=0,this.noteReleased=!1},t.exports=r},{}],2:[function(e,t,s){"use strict";var r={NONE:{representation:".",handler:function(e,t,s,r,n){}},ARPEGGIO:{representation:"0",handler:function(e,t,s,r,n){var a;s%3===0?a=0:s%3===1?a=64*((240&t)>>4):s%3===2&&(a=64*(15&t));var o=8363*Math.pow(2,(4608-e.period+a)/768);e.sample.step=o/n.sampleStepping}},PORTA_UP:{representation:"1",handler:function(e,t,s,r,n){if(0===s&&0!==t)e.porta.step=t;else if(s>0){e.period-=e.porta.step*n.ticksPerRow;var a=8363*Math.pow(2,(4608-e.period)/768);e.sample.step=a/n.sampleStepping}}},PORTA_DOWN:{representation:"2",handler:function(e,t,s,r,n){if(0===s&&0!==t)e.porta.step=t;else if(s>0){e.period+=e.porta.step*n.ticksPerRow;var a=8363*Math.pow(2,(4608-e.period)/768);e.sample.step=a/n.sampleStepping}}},TONE_PORTA:{representation:"3",handler:function(e,t,s,r,n){if(e.sample.sample){0===s&&0!==t&&(e.porta.step=t),0===s&&0!==n.getCurrentNote(r)&&(e.porta.notePeriod=7680-64*(n.getCurrentNote(r)-26-e.sample.sample.basePeriod)-e.sample.sample.fineTune/2),e.period<e.porta.notePeriod?(e.period+=e.porta.step*n.ticksPerRow,e.period>e.porta.notePeriod&&(e.period=e.porta.notePeriod)):e.period>e.porta.notePeriod&&(e.period-=e.porta.step*n.ticksPerRow,e.period<e.porta.notePeriod&&(e.period=e.porta.notePeriod));var a=8363*Math.pow(2,(4608-e.period)/768);e.sample.step=a/n.sampleStepping}}},VIBRATO:{representation:"4",handler:function(e,t,s,r,n){0===s&&0!==t&&(0!==(240&t)&&(e.vibrato.step=2*Math.PI*((240&t)>>4)*n.ticksPerRow/64),0!==(15&t)&&(e.vibrato.amplitude=2*(15&t)),e.vibrato.position=0);var a=Math.sin(e.vibrato.position)*e.vibrato.amplitude,o=8363*Math.pow(2,(4608-e.period+a)/768);e.sample.step=o/n.sampleStepping,e.vibrato.position+=e.vibrato.step}},TONE_PORTA_VOL_SLIDE:{representation:"5",handler:function(e,t,s,r,n){if(e.sample.sample){0===s&&0!=n.getCurrentNote(r)&&(e.porta.notePeriod=7680-64*(n.getCurrentNote(r)-26-e.sample.sample.basePeriod)-e.sample.sample.fineTune/2),e.period<e.porta.notePeriod?(e.period+=e.porta.step,e.period>e.porta.notePeriod&&(e.period=e.porta.notePeriod)):e.period>e.porta.notePeriod&&(e.period-=e.porta.step,e.period<e.porta.notePeriod&&(e.period=e.porta.notePeriod));var a=8363*Math.pow(2,(4608-e.period)/768);e.sample.step=a/n.sampleStepping;var o=(0!=(240&t)?(240&t)>>4:-(15&t))/64;e.volume.channelVolume=Math.max(0,Math.min(e.volume.channelVolume+o,1))}}},VIBRATO_VOL_SLIDE:{representation:"6",handler:function(e,t,s,r,n){0===s&&0!==t&&(e.volume.channelVolumeSlide=t);var a=Math.sin(e.vibrato.position)*e.vibrato.amplitude,o=8363*Math.pow(2,(4608-e.period+a)/768);e.sample.step=o/n.sampleStepping,e.vibrato.position+=e.vibrato.step;var i=(0!=(240&e.volume.channelVolumeSlide)?(240&e.volume.channelVolumeSlide)>>4:-(15&e.volume.channelVolumeSlide))/64;e.volume.channelVolume=Math.max(0,Math.min(e.volume.channelVolume+i,1))}},TREMOLO:{representation:"7",handler:function(e,t,s,r,n){0===s&&0!==t&&(0!==(240&t)&&(e.tremolo.step=2*Math.PI*((240&t)>>4)*n.ticksPerRow/64),0!==(15&t)&&(e.tremolo.amplitude=(15&t)/30),e.tremolo.position=0),e.tremolo.volume=1-Math.sin(e.tremolo.position)*e.tremolo.amplitude,e.tremolo.position+=e.tremolo.step}},SET_PAN:{representation:"8",handler:function(e,t,s,r,n){0===s&&(e.panning.pan=1-t/128)}},SAMPLE_OFFSET:{representation:"9",handler:function(e,t,s,r,n){0===s&&(e.sample.restart=256*t,e.sample.position=256*t,e.sample.remain-=256*t)}},VOLUME_SLIDE:{representation:"A",handler:function(e,t,s,r,n){if(0===s&&0!==t&&(e.volume.channelVolumeSlide=t),s>0&&0!==e.volume.channelVolumeSlide)if(240===(240&e.volume.channelVolumeSlide)&&0!==(15&e.volume.channelVolumeSlide)){if(1===s){var a=(15&e.volume.channelVolumeSlide)/64;e.volume.channelVolume=Math.max(0,e.volume.channelVolume-a)}}else if(15===(15&e.volume.channelVolumeSlide)&&0!==(240&e.volume.channelVolumeSlide)){if(1===s){var a=((240&e.volume.channelVolumeSlide)>>4)/64;e.volume.channelVolume=Math.min(1,e.volume.channelVolume+a)}}else{var a=(0!=(240&e.volume.channelVolumeSlide)?(240&e.volume.channelVolumeSlide)>>4:-(15&e.volume.channelVolumeSlide))/64;e.volume.channelVolume=Math.max(0,Math.min(e.volume.channelVolume+a,1))}}},POSITION_JUMP:{representation:"B",handler:function(e,t,s,r,n){0===s&&(n.orderJump=t)}},SET_VOLUME:{representation:"C",handler:function(e,t,s,r,n){0===s&&(e.volume.channelVolume=Math.max(0,Math.min(t/64,1)))}},PATTERN_BREAK:{representation:"D",handler:function(e,t,s,r,n){0===s&&(n.breakPattern=10*((240&t)>>4)+(15&t))}},SET_FILTER:{representation:"E",handler:function(e,t,s,r,n){0===s&&console.log("Effect not supported: SET_FILTER")}},FINE_PORTA_UP:{representation:"E",handler:function(e,t,s,r,n){if(0===s){t&!0&&(e.porta.step=15&t),e.period-=e.porta.step*n.ticksPerRow;var a=8363*Math.pow(2,(4608-e.period)/768);e.sample.step=a/n.sampleStepping}}},FINE_PORTA_DOWN:{representation:"E",handler:function(e,t,s,r,n){if(0===s){t&!0&&(e.porta.step=15&t),e.period+=e.porta.step*n.ticksPerRow;var a=8363*Math.pow(2,(4608-e.period)/768);e.sample.step=a/n.sampleStepping}}},SET_GLISANDO:{representation:"E",handler:function(e,t,s,r,n){0===s&&console.log("Effect not supported: SET_GLISANDO")}},SET_VIBRATO:{representation:"E",handler:function(e,t,s,r,n){0===s&&console.log("Effect not supported: SET_VIBRATO")}},SET_FINETUNE:{representation:"E",handler:function(e,t,s,r,n){0===s&&null!==e.sample.sample&&(e.sample.sample.fineTune=15&t)}},SET_LOOP:{representation:"E",handler:function(e,t,s,r,n){0===s&&(0===(15&t)?e.loopMark=n.currentRow:(0==e.loopCount?e.loopCount=15&t:e.loopCount--,e.loopCount>0&&(n.rowJump=e.loopMark)))}},SET_TREMOLO:{representation:"E",handler:function(e,t,s,r,n){0===s&&console.log("Effect not supported: SET_TREMOLO")}},SET_PAN_16:{representation:"E",handler:function(e,t,s,r,n){0===s&&(e.panning.pan=(15&t)/15)}},RETRIGGER:{representation:"E",handler:function(e,t,s,n,a){s%(15&t)===0&&e.sample.sample&&(e.sample.remain=e.sample.sample.sampleLength-e.sample.restart,e.sample.position=e.sample.restart,a.dispatchEvent(ScripTracker.Events.instrument,a,n,e.instrument,e.note,r.RETRIGGER,t))}},FINE_VOL_SLIDE_UP:{representation:"E",handler:function(e,t,s,r,n){0===s&&(e.volume.channelVolume=Math.min(e.volume.channelVolume+(15&t)/15,1))}},FINE_VOL_SLIDE_DOWN:{representation:"E",handler:function(e,t,s,r,n){0===s&&(e.volume.channelVolume=Math.max(0,e.volume.channelVolume-(15&t)/15))}},CUT_NOTE:{representation:"E",handler:function(e,t,s,r,n){s===(15&t)&&(e.volume.channelVolume=0)}},DELAY_NOTE:{representation:"E",handler:function(e,t,s,r,n){0===s&&(e.noteDelay=15&t)}},DELAY_PATTERN:{representation:"E",handler:function(e,t,s,r,n){0===e.patternDelay&&(e.patternDelay=(15&t)+1)}},SET_TEMPO_BPM:{representation:"F",handler:function(e,t,s,n,a){0===s&&(32>=t?r.SET_SPEED.handler(e,t,s,n,a):r.SET_TEMPO.handler(e,t,s,n,a))}},SET_SPEED:{representation:"F",handler:function(e,t,s,r,n){if(0===s)if(0!==t){n.ticksPerRow=t;var a=24*n.bpm/n.ticksPerRow,o=a*n.ticksPerRow;n.samplesPerTick=Math.round(n.sampleRate/(o/60))}else n.stop(),n.resetPlayback()}},SET_TEMPO:{representation:"F",handler:function(e,t,s,r,n){if(0===s){n.bpm=t;var a=24*n.bpm/n.ticksPerRow,o=a*n.ticksPerRow;n.samplesPerTick=Math.round(n.sampleRate/(o/60))}}},RETRIG_VOL_SLIDE:{representation:"R",handler:function(e,t,s,r,n){if(s%(15&t)===0&&e.sample.sample&&(e.sample.remain=e.sample.sample.sampleLength-e.sample.restart,e.sample.position=e.sample.restart),0===s&&0!==(240&t))e.volume.channelVolumeSlide=(240&t)>>4;else if(s>0){switch(e.volume.channelVolumeSlide){case 1:e.volume.channelVolume-=1/64;break;case 2:e.volume.channelVolume-=2/64;break;case 3:e.volume.channelVolume-=4/64;break;case 4:e.volume.channelVolume-=.125;break;case 5:e.volume.channelVolume-=.25;break;case 6:e.volume.channelVolume*=.67;break;case 7:e.volume.channelVolume*=.5;break;case 9:e.volume.channelVolume+=1/64;break;case 10:e.volume.channelVolume+=2/64;break;case 11:e.volume.channelVolume+=4/64;break;case 12:e.volume.channelVolume+=.125;break;case 13:e.volume.channelVolume+=.25;break;case 14:e.volume.channelVolume*=1.5;break;case 15:e.volume.channelVolume*=2}e.volume.channelVolume=Math.max(0,Math.min(e.volume.channelVolume,1))}}},SET_GLOBAL_VOLUME:{representation:"G",handler:function(e,t,s,r,n){0===s&&(n.masterVolume=Math.max(0,Math.min(t/64,1)))}},GLOBAL_VOLUME_SLIDE:{representation:"H",handler:function(e,t,s,r,n){0===s&&0!==t&&(n.masterVolume=(0!=(240&t)?(240&t)>>4:-(15&t))/64),s>0&&0!==n.masterVolSlide&&(n.masterVolume=Math.max(0,Math.min(n.getMasterVolume()+n.masterVolSlide,1)))}},ENVELOPE_POSITION:{representation:"L",handler:function(e,t,s,r,n){0===s&&(e.envelopePosition=t)}},PAN_SLIDE:{representation:"P",handler:function(e,t,s,r,n){0===s&&0!==t&&(e.panning.panSlide=((240&t)>0?(240&t)>>4:-(15&t))/64),s>0&&(e.panning.pan=Math.max(0,Math.min(e.panning.pan+e.panning.panSlide,1)))}},TREMOR:{representation:"T",handler:function(e,t,s,r,n){if(0===s&&0!==t)e.tremor.onCount=240&t,e.tremor.offCount=15&t,e.tremor.muted=!1;else{var a=e.tremor.onCount+e.tremor.offCount;e.tremor.muted=s%a>=e.tremor.onCount}}},FINE_VIBRATO:{representation:"U",handler:function(e,t,s,r,n){if(0===s&&0!==t&&(0!=(240&t)&&(e.vibrato.step=2*Math.PI*((240&t)>>4)*n.ticksPerRow/64),0!=(15&t)&&(e.vibrato.amplitude=8*(15&t)),e.vibrato.position=0),s%4==0){var a=Math.sin(e.vibrato.position)*e.vibrato.amplitude,o=8363*Math.pow(2,(4608-e.period+a)/768);e.sample.step=o/n.sampleStepping,e.vibrato.position+=e.vibrato.step}}},EXTRA_FINE_PORTA_UP:{representation:"X",handler:function(e,t,s,r,n){if(0===s){t&!0&&(e.porta.step=15&t),e.period-=e.porta.step;var a=8363*Math.pow(2,(4608-e.period)/768);e.sample.step=a/n.sampleStepping}}},EXTRA_FINE_PORTA_DOWN:{representation:"X",handler:function(e,t,s,r,n){if(0===s){t&!0&&(e.porta.step=15&t),e.period+=e.porta.step;var a=8363*Math.pow(2,(4608-e.period)/768);e.sample.step=a/n.sampleStepping}}},VOLUME_EFFECT:{representation:"V",handler:function(e,t,s,n,a){var o=(240&t)>>4,i=15&t;switch(o){case 5:r.VOLUME_SLIDE.handler(e,i,s,n,a);break;case 6:i<<=4,r.VOLUME_SLIDE.handler(e,i,s,n,a);break;case 7:i=240+i,r.VOLUME_SLIDE.handler(e,i,s,n,a);break;case 8:i=(i<<4)+15,r.VOLUME_SLIDE.handler(e,i,s,n,a);break;case 9:i<<=4,r.VIBRATO.handler(e,i,s,n,a);break;case 10:r.VIBRATO.handler(e,i,s,n,a);break;case 11:i=2*i+11,r.SET_PAN.handler(e,i,s,n,a);break;case 12:r.PAN_SLIDE.handler(e,i,s,n,a);break;case 13:i<<=4,r.PAN_SLIDE.handler(e,i,s,n,a);break;case 14:i*=4,r.TONE_PORTA.handler(e,i,s,n,a)}}}};t.exports=r},{}],3:[function(e,t,s){"use strict";var r=function(){this.type=r.EnvelopeType.NONE,this.points=[],this.lastPosition=-1,this.lastValue=0,this.sustainPoint=0,this.loopBegin=0,this.loopEnd=0};r.prototype.addPoint=function(e,t,s,r,n){for(var a=e-this.lastPosition,o=(t-this.lastValue)/a,i=0;a>i;i++)this.lastPosition++,this.lastValue+=o,this.points.push(this.lastValue);s&&(this.sustainPoint=this.lastPosition),r&&(this.loopBegin=this.lastPosition),n&&(this.loopEnd=this.lastPosition)},r.prototype.getValue=function(e,t,s){if(e=Math.round(e),0!=(this.type&r.EnvelopeType.SUSTAIN))return t?this.points[Math.min(e,this.points.length-1)]:this.points[Math.min(e,this.sustainPoint)];if(0!=(this.type&r.EnvelopeType.LOOP)){var n;return n=e>=this.loopBegin?this.loopBegin+(e-this.loopBegin)%(this.loopEnd-this.loopBegin):e,this.points[Math.min(n,this.points.length-1)]}return 0!=(this.type&r.EnvelopeType.ON)?this.points[Math.min(e,this.points.length-1)]:t?0:s},r.EnvelopeType={NONE:0,ON:1,SUSTAIN:2,LOOP:4},t.exports=r},{}],4:[function(e,t,s){"use strict";var r=e("./channel"),n=e("./mod_module"),a=e("./s3m_module"),o=e("./xm_module"),i=e("./sample"),l=e("./effects"),p=function(){if(this.module=null,this.pattern=null,this.orderIndex=0,this.currentRow=0,this.currentTick=0,this.sampleRate=0,this.bpm=0,this.ticksPerRow=0,this.samplesPerTick=0,this.sampleCount=0,this.sampleStepping=0,this.isPlaying=!1,this.masterVolume=1,this.masterVolSlide=0,this.breakPattern=-1,this.orderJump=-1,this.rowJump=-1,this.patternDelay=0,this.patternLoop=!1,this.channelRegisters=[],this.audioContext=null,this.audioSource=null,this.audioScriptNode=null,this.bufferSize=4096,this.eventHandlers={SONG_LOADED:[],PLAY:[],STOP:[],SONG_END:[],NEW_ROW:[],NEW_ORDER:[],INSTRUMENT:[],EFFECT:[]},"undefined"!=typeof AudioContext)this.audioContext=new AudioContext;else{if("undefined"==typeof webkitAudioContext)return void console.error("Unable to create AudioContext");this.audioContext=new webkitAudioContext}this.audioSource=this.audioContext.createBufferSource(),this.audioScriptNode=this.audioContext.createScriptProcessor(this.bufferSize,1,2),this.sampleRate=this.audioContext.sampleRate,this.sampleStepping=3*Math.round(.02*this.sampleRate),this.audioScriptNode.onaudioprocess=this.fillBuffer.bind(this),this.audioSource.start(0)};p.prototype.fillBuffer=function(e){if(this.isPlaying&&this.module)for(var t=e.outputBuffer,s=t.getChannelData(0),r=t.getChannelData(1),n=0;n<t.length;n++){for(var a=0,o=0,l=0;l<this.module.channels;l++){var p=this.channelRegisters[l];if(p.sample.sample){var h=p.sample.sample.sample[Math.floor(p.sample.position)],m=p.volume.envelope.getValue(p.envelopePos,p.noteReleased,1),u=p.panning.envelope.getValue(p.envelopePos,p.noteReleased,.5),c=m*p.tremolo.volume*p.volume.channelVolume,d=Math.max(0,Math.min(p.panning.pan+(u-.5)*((2-Math.abs(p.panning.pan-2))/.5),1));p.envelopePos+=1/this.samplesPerTick,p.isMuted||p.tremor.muted||(p.panning.pan<=1?(a+=h*(1-d)*c,o+=h*d*c):(a+=.5*h*c,o-=.5*h*c)),p.sample.position+=p.sample.reversed?-p.sample.step:p.sample.step,p.sample.remain-=Math.abs(p.sample.step),p.sample.remain<=0&&(p.sample.sample.loopType===i.LoopType.FORWARD?(p.sample.position=p.sample.sample.loopStart-p.sample.remain,p.sample.remain=p.sample.sample.loopLength+p.sample.remain):p.sample.sample.loopType===i.LoopType.PINGPONG?(p.sample.position=Math.max(p.sample.sample.loopStart,p.sample.position),p.sample.position=Math.min(p.sample.sample.loopStart+p.sample.sample.loopLength-1,p.sample.position),p.sample.remain=p.sample.sample.loopLength,p.sample.reversed=!p.sample.reversed):(p.sample.position=p.sample.sample.sampleLength-1,p.sample.step=0))}}s[n]=a*this.masterVolume,r[n]=o*this.masterVolume,this.sampleCount++,this.sampleCount===this.samplesPerTick&&(this.sampleCount=0,this.currentTick++,this.currentTick===this.ticksPerRow&&this.processRowEnd(),this.processTick())}},p.prototype.processTick=function(){0===this.currentTick&&(0===this.currentRow&&this.dispatchEvent(p.Events.order,this),this.dispatchEvent(p.Events.row,this));for(var e=0;e<this.module.channels;e++){var t=this.channelRegisters[e],s=this.pattern.note[this.currentRow][e],r=this.pattern.instrument[this.currentRow][e],n=this.pattern.volume[this.currentRow][e],a=this.pattern.effect[this.currentRow][e],o=this.pattern.effectParam[this.currentRow][e];if(0===this.currentTick){if(0!==r){t.instrument=r,this.dispatchEvent(p.Events.instrument,this,e,t.instrument,s,a,o);var i=this.module.instruments[r-1];if(i){var h=Math.max(0,i.sampleKeyMap[s]-1);i.samples[h]&&(t.sample.sample=i.samples[h],t.sample.remain=t.sample.sample.sampleLength,t.volume.sampleVolume=t.sample.sample.volume),t.sample.position=0,t.sample.restart=0,t.sample.reversed=!1,t.volume.envelope=i.volumeEnvelope,t.panning.envelope=i.panningEnvelope,t.envelopePos=0,t.noteReleased=!1,"mod"!==this.module.type&&t.sample.sample&&(t.panning.pan=t.sample.sample.panning),t.sample.sample&&t.sample.sample.sampleLength<1&&(t.sample.sample=null)}else t.sample.sample=null}if(0!==s&&a!==l.TONE_PORTA&&a!==l.TONE_PORTA_VOL_SLIDE)if(97===s)t.note=s,t.noteReleased=!0;else if(t.note=s-1,null!==t.sample.sample){t.period=7680-64*(s-26-t.sample.sample.basePeriod)-t.sample.sample.fineTune/2;var m=8363*Math.pow(2,(4608-t.period)/768);t.sample.position=t.sample.restart,t.volume.sampleVolume=t.sample.sample.volume,t.sample.remain=t.sample.sample.sampleLength-t.sample.restart,t.sample.step=m/this.sampleStepping,t.sample.reversed=!1,t.noteDelay=0,0===r&&this.dispatchEvent(p.Events.instrument,this,e,t.instrument,s,a,o)}t.tremolo.volume=1,t.tremor.muted=!1,n>=0&&64>=n?t.volume.channelVolume=n/64:97>s&&0!==r&&(t.volume.channelVolume=t.volume.sampleVolume),a!==l.NONE&&this.dispatchEvent(p.Events.effect,this,e,t.instrument,s,a,o)}n>64&&l.VOLUME_EFFECT.handler(t,n,this.currentTick,e,this),a.handler(t,o,this.currentTick,e,this)}},p.prototype.processRowEnd=function(){if(-1===this.orderJump||this.patternLoop||(this.currentRow=-1,this.orderIndex=Math.min(this.module.songLength-1,this.orderJump),this.pattern=this.module.patterns[this.module.orders[this.orderIndex]]),-1!==this.breakPattern&&(this.currentRow=this.breakPattern-1,!this.patternLoop&&-1===this.orderJump)){for(this.orderIndex++;254===this.module.orders[this.orderIndex]&&this.orderIndex<this.module.songLength;)this.orderIndex++;(this.orderIndex===this.module.songLength||255==this.module.orders[this.orderIndex])&&(this.orderIndex=this.module.restartPosition),this.pattern=this.module.patterns[this.module.orders[this.orderIndex]]}if(-1!==this.rowJump&&(this.currentRow=this.rowJump-1,this.rowJump=-1),this.patternDelay<2?(this.orderJump=-1,this.breakPattern=-1,this.currentTick=0,this.patternDelay=0,this.currentRow++):this.patternDelay--,!this.pattern)return this.dispatchEvent(p.Events.songEnded,this),this.stop(),this.rewind(),void this.resetPlayback();if(this.currentRow===this.pattern.rows){for(this.currentRow=0,this.patternLoop||this.orderIndex++;254===this.module.orders[this.orderIndex]&&this.orderIndex<this.module.songLength;)this.orderIndex++;(this.orderIndex>=this.module.songLength||255===this.module.orders[this.orderIndex])&&(this.dispatchEvent(p.Events.songEnded,this),this.orderIndex=this.module.restartPosition,this.resetPlayback()),this.pattern=this.module.patterns[this.module.orders[this.orderIndex]]}},p.prototype.resetPlayback=function(){for(var e=0;e<this.channelRegisters.length;e++)this.channelRegisters[e].reset();this.masterVolume=.9,this.masterVolSlide=0,this.breakPattern=-1,this.orderJump=-1,this.rowJump=-1,this.patternDelay=0,this.orderIndex=0,this.currentRow=0,this.currentTick=0,this.sampleCount=0,this.pattern=this.module.patterns[this.module.orders[this.orderIndex]],l.SET_TEMPO.handler(this.channelRegisters[0],this.module.defaultBPM,0,0,this),l.SET_SPEED.handler(this.channelRegisters[0],this.module.defaultTempo,0,0,this)},p.prototype.loadModule=function(e){this.isPlaying&&this.stop(),this.module=null;var t=e.split(".").pop().toLowerCase(),s=new XMLHttpRequest;s.onload=function(e){var r=s.response;r&&this.loadRaw(new Uint8Array(r),t)}.bind(this),s.open("get",e,!0),s.responseType="arraybuffer",s.send()},p.prototype.loadRaw=function(e,t){switch(t){case"mod":this.module=new n(e);break;case"s3m":this.module=new a(e);break;case"xm":this.module=new o(e);break;default:return}this.channelRegisters=[];for(var s=0;s<this.module.channels;s++)this.channelRegisters.push(new r),"mod"==this.module.type&&(this.channelRegisters[s].panning.pan=s%2==0?.7:.3);this.resetPlayback(),this.dispatchEvent(p.Events.playerReady,this)},p.prototype.play=function(){this.isPlaying||null==this.module||(this.dispatchEvent(p.Events.play,this),this.isPlaying=!0,this.processTick(),this.audioSource.connect(this.audioScriptNode),this.audioScriptNode.connect(this.audioContext.destination))},p.prototype.stop=function(){this.audioScriptNode.disconnect(this.audioContext.destination),this.audioSource.disconnect(this.audioScriptNode),this.isPlaying=!1,this.dispatchEvent(p.Events.stop,this)},p.prototype.prevOrder=function(){null!=this.module&&this.orderIndex-1>=0&&254!=this.module.orders[this.orderIndex]&&(this.orderIndex--,this.pattern=this.module.patterns[this.module.orders[this.orderIndex]],this.restartOrder())},p.prototype.nextOrder=function(){null!=this.module&&this.orderIndex<this.module.orders.length-1&&(this.orderIndex++,this.pattern=this.module.patterns[this.module.orders[this.orderIndex]],this.restartOrder())},p.prototype.rewind=function(){null!=this.module&&(this.orderIndex=0,this.pattern=this.module.patterns[this.module.orders[this.orderIndex]],this.restartOrder())},p.prototype.restartOrder=function(){if(null!=this.module){this.currentRow=0,this.currentTick=0,this.sampleCount=0;for(var e=0;e<this.module.channels;e++)this.channelRegisters[e].reset();this.processTick()}},p.prototype.isMuted=function(e){return e<this.channelRegisters.length?this.channelRegisters[e].isMuted:!0},p.prototype.isPatternLoop=function(){return this.patternLoop},p.prototype.setMute=function(e,t){e<this.channelRegisters.length&&(this.channelRegisters[e].isMuted=t)},p.prototype.setPatternLoop=function(e){this.patternLoop=e},p.prototype.getSongName=function(){return this.module.name},p.prototype.getCurrentOrder=function(){return this.orderIndex+1},p.prototype.getCurrentPattern=function(){return this.module.orders[this.orderIndex]},p.prototype.getSongLength=function(){return this.module.songLength},p.prototype.getCurrentBPM=function(){return this.bpm},p.prototype.getCurrentTicks=function(){return this.ticksPerRow},p.prototype.getCurrentRow=function(){return this.currentRow},p.prototype.getPatternRows=function(){return this.pattern.rows},p.prototype.getChannelVolume=function(e){return this.channelRegisters[e].volume.sampleVolume*this.channelRegisters[e].volume.channelVolume*this.masterVolume},p.prototype.getChannelInstrument=function(e){var t=this.channelRegisters[e];return t.sample.sample&&t.sample.step>0?t.sample.sample.name:""},p.prototype.getNoteInfo=function(e,t){return this.pattern.toText(t,e,this.module.type)},p.prototype.getSampleRate=function(){return this.sampleRate},p.prototype.getCurrentNote=function(e){return this.pattern.note[this.currentRow][e]},p.prototype.getMasterVolume=function(){return this.masterVolume},p.prototype.setMasterVolume=function(e){this.masterVolume=e},p.prototype.on=function(e,t){switch(e){case p.Events.instrument:case p.Events.effect:this.eventHandlers[e].push({handler:arguments[2],param:arguments[1]});break;default:this.eventHandlers[e].push(t)}},p.prototype.off=function(e,t){var s=this.eventHandlers[e];switch(e){case p.Events.instrument:case p.Events.effect:for(var r=0;r<s.length;r++)(1===arguments.length||s[r].handler===arguments[2]&&s[r].param===arguments[1])&&(s.splice(r,1),r--);break;default:for(var r=0;r<s.length;r++)t&&s[r]!==t||(s.splice(r,1),r--)}},p.prototype.dispatchEvent=function(e,t,s,r,n,a,o){var i=this.eventHandlers[e];switch(e){case p.Events.playerReady:for(var l=0;l<i.length;l++)i[l](t,t.getSongName(),t.getSongLength());break;case p.Events.order:for(var l=0;l<i.length;l++)i[l](t,t.getCurrentOrder(),t.getSongLength(),t.getCurrentPattern());break;case p.Events.row:for(var l=0;l<i.length;l++)i[l](t,t.getCurrentRow(),t.getPatternRows());break;case p.Events.instrument:for(var l=0;l<i.length;l++)i[l].param===r&&i[l].handler(t,r,s,n,a,o);break;case p.Events.effect:for(var l=0;l<i.length;l++)i[l].param===a&&i[l].handler(t,a,o,s,r,n);break;case p.Events.error:for(var l=0;l<i.length;l++)i[l].handler(t,s);break;default:for(var l=0;l<i.length;l++)i[l](t)}},p.prototype.debug=function(){this.audioScriptNode.disconnect(this.audioContext.destination),this.audioSource.disconnect(this.audioScriptNode),this.isPlaying=!1,this.dispatchEvent(p.Events.stop,this);this.channelRegisters},p.Events={playerReady:"SONG_LOADED",play:"PLAY",stop:"STOP",songEnded:"SONG_END",row:"NEW_ROW",order:"NEW_ORDER",instrument:"INSTRUMENT",effect:"EFFECT",error:"ERROR"},window&&(window.ScripTracker=p),t.exports=p},{"./channel":1,"./effects":2,"./mod_module":7,"./s3m_module":10,"./sample":11,"./xm_module":12}],5:[function(e,t,s){"use strict";var r={readWord:function(e,t){return e[t]+(e[t+1]<<8)},readWordBE:function(e,t){return(e[t]<<8)+e[t+1]},readDWord:function(e,t){return e[t]+(e[t+1]<<8)+(e[t+2]<<16)+(e[t+3]<<24)},readString:function(e,t,s){var r="";if(s)for(var n=0;s>n;n++)r+=String.fromCharCode(e[t+n]);else for(;e[t];)r+=String.fromCharCode(e[t++]);return r}};t.exports=r},{}],6:[function(e,t,s){"use strict";var r=e("./envelope"),n=function(){this.name="",this.type=0,this.numSamples=0,this.sampleKeyMap=[],this.samples=[],this.volumeEnvelope=new r,this.panningEnvelope=new r;for(var e=0;96>e;e++)this.sampleKeyMap.push(0)};t.exports=n},{"./envelope":3}],7:[function(e,t,s){"use strict";var r=e("./module"),n=e("./pattern"),a=e("./instrument"),o=e("./sample"),i=e("./effects"),l=e("./helpers"),p=function(e){r.call(this),this.type=r.Types.MOD;var t=[1712,1616,1524,1440,1356,1280,1208,1140,1076,1016,960,906,856,808,762,720,678,640,604,570,538,508,480,453,428,404,381,360,339,320,302,285,269,254,240,226,214,202,190,180,170,160,151,143,135,127,120,113,107,101,95,90,85,80,75,71,67,63,60,56];switch(l.readString(e,1080,4)){case"6CHN":this.channels=6;break;case"FLT8":case"8CHN":case"CD81":case"OKTA":this.channels=8;break;case"16CN":this.channels=16;break;case"32CN":this.channels=32;break;default:this.channels=4}this.name=l.readString(e,0,20),this.songLength=e[950],this.restartPosition=e[951];for(var s=0;31>s;s++){var p=e.subarray(20+30*s,50+30*s),h=new a,m=new o;m.name=l.readString(p,0,22),m.sampleLength=2*l.readWordBE(p,22),m.fineTune=15&p[24],m.volume=Math.min(p[25],64)/64,m.loopStart=2*l.readWordBE(p,26),m.loopLength=2*l.readWordBE(p,28),m.loopType=m.loopLength>1?o.LoopType.FORWARD:o.LoopType.NONE,m.fineTune>7&&(m.fineTune-=16),m.fineTune*=16,h.name=m.name,h.samples.push(m),this.instruments.push(h)}for(var u=0,s=0;128>s;s++)this.orders[s]=e[952+s],u=Math.max(u,this.orders[s]+1);for(var c=256*this.channels,s=0;u>s;s++){for(var d=e.subarray(1084+s*c,1084+s*c+c),f=new n(64,this.channels),E=0;64>E;E++)for(var v=0;v<this.channels;v++){var T=E*this.channels*4+4*v,O=d[T],P=d[T+1],S=d[T+2],g=d[T+3],R=256*(15&O)|P;if(0==R)f.note[E][v]=0;else if(R>t[0])f.note[E][v]=1;else if(R<=t[t.length-1])f.note[E][v]=60;else for(var _=0;_<t.length-1;_++)if(R==t[_]){f.note[E][v]=_+1;break}if(f.instrument[E][v]=240&O|(240&S)/16,f.volume[E][v]=-1,f.effectParam[E][v]=g,0==(15&S)&&0!=g)f.effect[E][v]=i.ARPEGGIO;else if(1==(15&S))f.effect[E][v]=i.PORTA_UP;else if(2==(15&S))f.effect[E][v]=i.PORTA_DOWN;else if(3==(15&S))f.effect[E][v]=i.TONE_PORTA;else if(4==(15&S))f.effect[E][v]=i.VIBRATO;else if(5==(15&S))f.effect[E][v]=i.TONE_PORTA_VOL_SLIDE;else if(6==(15&S))f.effect[E][v]=i.VIBRATO_VOL_SLIDE;else if(7==(15&S))f.effect[E][v]=i.TREMOLO;else if(8==(15&S))f.effect[E][v]=i.SET_PAN;else if(9==(15&S))f.effect[E][v]=i.SAMPLE_OFFSET;else if(10==(15&S))f.effect[E][v]=i.VOLUME_SLIDE;else if(11==(15&S))f.effect[E][v]=i.POSITION_JUMP;else if(12==(15&S))f.effect[E][v]=i.SET_VOLUME;else if(13==(15&S))f.effect[E][v]=i.PATTERN_BREAK;else if(14==(15&S))switch((240&g)>>4){case 0:f.effect[E][v]=i.SET_FILTER;break;case 1:f.effect[E][v]=i.FINE_PORTA_UP;break;case 2:f.effect[E][v]=i.FINE_PORTA_DOWN;break;case 3:f.effect[E][v]=i.SET_GLISANDO;break;case 4:f.effect[E][v]=i.SET_VIBRATO;break;case 5:f.effect[E][v]=i.SET_FINETUNE;break;case 6:f.effect[E][v]=i.SET_LOOP;break;case 7:f.effect[E][v]=i.SET_TREMOLO;break;case 8:f.effect[E][v]=i.SET_PAN_16;break;case 9:f.effect[E][v]=i.RETRIGGER;break;case 10:f.effect[E][v]=i.FINE_VOL_SLIDE_UP;break;case 11:f.effect[E][v]=i.FINE_VOL_SLIDE_DOWN;break;case 12:f.effect[E][v]=i.CUT_NOTE;break;case 13:f.effect[E][v]=i.DELAY_NOTE;break;case 14:f.effect[E][v]=i.DELAY_PATTERN;break;default:f.effect[E][v]=i.NONE}else f.effect[E][v]=15==(15&S)?i.SET_TEMPO_BPM:i.NONE}this.patterns.push(f)}for(var L=u*c+1084,s=0;s<this.instruments.length;s++)this.instruments[s].samples[0].loadSample(e.subarray(L,L+this.instruments[s].samples[0].sampleLength),this.signedSample),this.instruments[s].samples[0].sample[0]=0,this.instruments[s].samples[0].sample[1]=0,L+=this.instruments[s].samples[0].sampleLength};p.prototype=Object.create(r.prototype),t.exports=p},{"./effects":2,"./helpers":5,"./instrument":6,"./module":8,"./pattern":9,"./sample":11}],8:[function(e,t,s){"use strict";var r=function(){this.name="",this.type=null,this.songLength=0,this.restartPosition=0,this.orders=[],this.channels=0,this.patternCount=0,this.patterns=[],this.instrumentCount=0,this.instruments=[],this.signedSample=!0,this.defaultTempo=6,this.defaultBPM=125,this.defaultVolume=1};r.Types={MOD:"mod",S3M:"s3m",IT:"it",XM:"xm"},t.exports=r},{}],9:[function(e,t,s){"use strict";var r=e("./effects"),n=function(e,t){this.patternIndex=0,this.rows=e,this.columns=t,this.note=[],this.instrument=[],this.volume=[],this.effect=[],this.effectParam=[];for(var s=0;e>s;s++){this.note[s]=[],this.instrument[s]=[],this.volume[s]=[],this.effect[s]=[],this.effectParam[s]=[];for(var n=0;t>n;n++)this.note[s][n]=0,this.instrument[s][n]=0,this.volume[s][n]=-1,this.effect[s][n]=r.NONE,this.effectParam[s][n]=0}};n.prototype.toText=function(e,t,s){var n=["C-","C#","D-","D#","E-","F-","F#","G-","G#","A-","A#","B-"],a="0123456789ABCDEF",o="DCBAUHPLRG",i="";if(0>e||e>=this.rows||0>t||t>=this.columns)return"... .. .. ...";if(0==this.note[e][t]?i+="...":97==this.note[e][t]?i+="===":(i+=n[(this.note[e][t]-1)%12],i+=Math.floor((this.note[e][t]-1)/12)),i+=" ",0!=this.instrument[e][t]?(i+=a.charAt(Math.floor(this.instrument[e][t]/16)),i+=a.charAt(this.instrument[e][t]%16)):i+="..",i+=" ",this.volume[e][t]>-1){var l=this.volume[e][t];i+=l>=80?o.charAt(Math.floor((l-80)/16)):a.charAt(Math.floor(l/16)),i+=a.charAt(l%16)}else i+="..";return i+=" ",this.effect[e][t]!=r.NONE?(i+=this.effect[e][t].representation,11==i.length&&(i+=a.charAt(Math.floor(this.effectParam[e][t]/16))),i+=a.charAt(this.effectParam[e][t]%16)):i+="...",i},t.exports=n},{"./effects":2}],10:[function(e,t,s){"use strict";var r=e("./module"),n=e("./pattern"),a=e("./instrument"),o=e("./sample"),i=e("./effects"),l=e("./helpers"),p=function(e){r.call(this),this.type=r.Types.S3M,this.channels=32,this.name=l.readString(e,0,28),this.songLength=l.readWord(e,32),this.sampleCount=l.readWord(e,34),this.patternCount=l.readWord(e,36),this.signedSample=1===e[42]?!0:!1,this.volumeSlideFlag=0!==(64&e[38])||0===e[40],this.defaultVolume=e[48]/64,this.defaultTempo=0===e[49]?6:e[49],this.defaultBPM=e[50]<33?125:e[50],this.defaultVolume=e[51]/64;for(var t=0;t<this.songLength;t++)this.orders[t]=e[96+t];for(var s=96+this.songLength,p=96+this.songLength+2*this.sampleCount,t=0;t<this.sampleCount;t++){var h=new a,m=16*l.readWord(e,s+2*t),u=e.subarray(m,m+80),c=new o;c.sampleIndex=t,c.name=l.readString(u,48,28),
c.sampleLength=l.readWord(u,16),c.loopStart=l.readWord(u,20),c.loopLength=l.readWord(u,24)-c.loopStart,c.volume=u[28]/64,c.sampleBits=0!==(4&u[31])?o.Bits.FORMAT_16BIT:o.Bits.FORMAT_8BIT,c.loopType=0!==(1&u[31])?o.LoopType.FORWARD:o.LoopType.NONE,c.basePeriod=l.readWord(u,32),c.basePeriod=c.basePeriod/8363,c.basePeriod=Math.log(c.basePeriod)/Math.log(2)*768+3168,c.basePeriod=-(Math.floor(c.basePeriod/64)-72);var d=16*u[14]+4096*u[15],f=c.sampleLength*(c.sampleBits===o.Bits.FORMAT_16BIT?2:1);0===(2&u[31])?c.loadSample(e.subarray(d,d+f),this.signedSample):c.loadStereoSample(e.subarray(d,d+f),this.signedSample),h.name=c.name,h.samples.push(c),this.instruments.push(h)}for(var E=0;E<this.patternCount;E++){for(var v=16*l.readWord(e,p+2*E),T=l.readWord(e,v),O=e.subarray(v,v+T),P=new n(64,this.channels),S=2,t=0;64!==t&&O.length-S>0;){var g=O[S];if(0!==g){var R=31&g;if(0!==(32&g)){if(S++,254===O[S])P.note[t][R]=97;else if(255===O[S])P.note[t][R]=0;else{var _=12*Math.floor(O[S]/16);P.note[t][R]=O[S]%16+_+1}P.instrument[t][R]=O[++S]}if(P.volume[t][R]=0!==(64&g)?O[++S]:-1,0!==(128&g)){var L=O[++S],M=O[++S];switch(P.effectParam[t][R]=M,L){case 1:P.effect[t][R]=i.SET_SPEED;break;case 2:P.effect[t][R]=i.POSITION_JUMP;break;case 3:P.effect[t][R]=i.PATTERN_BREAK;break;case 4:P.effect[t][R]=i.VOLUME_SLIDE;break;case 5:P.effect[t][R]=i.PORTA_DOWN,M>=240?P.effectParam[t][R]=Math.round(M%16/16):M>=224&&(P.effectParam[t][R]=Math.round(M%16/4));break;case 6:P.effect[t][R]=i.PORTA_UP,M>=240?P.effectParam[t][R]=Math.round(M%16/16):M>=224&&(P.effectParam[t][R]=Math.round(M%16/4));break;case 7:P.effect[t][R]=i.TONE_PORTA;break;case 8:P.effect[t][R]=i.VIBRATO;break;case 9:P.effect[t][R]=i.TREMOR;break;case 10:P.effect[t][R]=i.ARPEGGIO;break;case 11:P.effect[t][R]=i.VIBRATO_VOL_SLIDE;break;case 12:P.effect[t][R]=i.TONE_PORTA_VOL_SLIDE;break;case 15:P.effect[t][R]=i.SAMPLE_OFFSET;break;case 17:P.effect[t][R]=i.RETRIG_VOL_SLIDE;break;case 18:P.effect[t][R]=i.TREMOLO;break;case 19:var N=(240&M)>>4;switch(N){case 0:P.effect[t][R]=i.SET_FILTER;break;case 1:P.effect[t][R]=i.SET_GLISANDO;break;case 2:P.effect[t][R]=i.SET_FINETUNE;break;case 3:P.effect[t][R]=i.SET_VIBRATO;break;case 4:P.effect[t][R]=i.SET_TREMOLO;break;case 8:case 10:P.effect[t][R]=i.SET_PAN_16;break;case 11:P.effect[t][R]=i.SET_LOOP;break;case 12:P.effect[t][R]=i.CUT_NOTE;break;case 13:P.effect[t][R]=i.DELAY_NOTE;break;case 14:P.effect[t][R]=i.DELAY_PATTERN;break;default:console.log("Unknown effect: "+L+", "+M),P.effect[t][R]=i.NONE}break;case 20:P.effect[t][R]=i.SET_TEMPO;break;case 21:break;case 22:P.effect[t][R]=i.SET_GLOBAL_VOLUME;break;default:console.log("Unknown effect: "+L+", "+M),P.effect[t][R]=i.NONE}}}else t++;S++}this.patterns.push(P)}};p.prototype=Object.create(r.prototype),t.exports=p},{"./effects":2,"./helpers":5,"./instrument":6,"./module":8,"./pattern":9,"./sample":11}],11:[function(e,t,s){"use strict";var r=e("./helpers"),n=function(){this.sampleIndex=0,this.name="",this.sampleLength=0,this.loopStart=0,this.loopLength=0,this.loopType=n.LoopType.NONE,this.sampleBits=n.Bits.FORMAT_8BIT,this.compression=n.Compression.UNCOMPRESSED,this.volume=1,this.panning=.5,this.basePeriod=0,this.fineTune=0,this.sample=[]};n.prototype.loadSample=function(e,t){this.sample=[];for(var s=this.sampleBits===n.Bits.FORMAT_16BIT,a=0,o=0;o<this.sampleLength;o++){if(s){var i=r.readWord(e,2*o);o++,a=t?32768>i?i/32767:-((65535^i)+1)/32768:i/32768-1}else{var l=e[o];a=t?128>l?l/127:-((255^l)+1)/128:l/128-1}this.sample.push(a)}},n.prototype.loadStereoSample=function(e,t){var s=this.sampleBits===n.Bits.FORMAT_16BIT;this.loadSample(sampledata.subarray(0,this.sampleLength*s?2:1),s,t);var r=this.sample;this.loadSample(sampledata.subarray(this.sampleLength*s?2:1),s,t);var a=this.sample;this.sample=[];for(var o=0;o<this.sampleLength;o++)this.sample.push((r[o]+a[o])/2)},n.prototype.loadDeltaSample=function(e){this.sample=[];for(var t=this.sampleBits===n.Bits.FORMAT_16BIT,s=0,a=0;a<this.sampleLength;a++)t?(s=(s+r.readWord(e,a++))%65536,this.sample.push(s>32767?-(65536-s)/32768:s/32768)):(s=(s+e[a])%256,this.sample.push(s>127?(256-s)/-128:s/128))},n.prototype.loadAdpcmSample=function(e){this.sample=[];for(var t=this.sampleBits===n.Bits.FORMAT_16BIT,s=[],a=0;16>a;a++)if(t){var o=r.readWord(e,a++);s[a]=32768>o?o/32767:-((65535^o)+1)/32768}else{var i=e[a];s[a]=128>i?i/127:-((255^i)+1)/128}for(var l=0,a=0;a<Math.floor(this.sampleLength/2);a++)l+=s[15&e[a+t?32:16]],this.sample.push(l),l+=s[e[a+t?32:16]>>4],this.sample.push(l)},n.LoopType={NONE:0,FORWARD:1,PINGPONG:2},n.Bits={FORMAT_8BIT:0,FORMAT_16BIT:1},n.Compression={UNCOMPRESSED:0,DELTA:1,ADPCM:2},t.exports=n},{"./helpers":5}],12:[function(e,t,s){"use strict";var r=e("./module"),n=e("./pattern"),a=e("./instrument"),o=e("./sample"),i=e("./envelope"),l=e("./effects"),p=e("./helpers"),h=function(e){r.call(this),this.type=r.Types.XM;var t=p.readDWord(e,60),s=0;this.name=p.readString(e,17,20),this.songLength=p.readWord(e,64),this.restartPosition=p.readWord(e,66),this.channels=p.readWord(e,68),this.patternCount=p.readWord(e,70),this.instrumentCount=p.readWord(e,72),this.defaultTempo=p.readWord(e,76),this.defaultBPM=p.readWord(e,78);for(var h=0;h<this.songLength;h++)this.orders.push(e[80+h]);s+=t+60;for(var m=0;m<this.patternCount;m++){var u=p.readDWord(e,s),c=p.readWord(e,s+5),d=p.readWord(e,s+7),f=new n(c,this.channels);if(f.patternIndex=m,0!=d)for(var E=s+u,v=0;c>v;v++)for(var T=0;T<this.channels;T++){var O=e[E++];if(0==(128&O)){f.note[v][T]=O,f.instrument[v][T]=e[E++];var P=Math.max(-1,e[E++]-16);f.volume[v][T]=P,f.effect[v][T]=e[E++],f.effectParam[v][T]=e[E++]}else{if(0!=(1&O)&&(f.note[v][T]=e[E++]),0!=(2&O)&&(f.instrument[v][T]=e[E++]),0!=(4&O)){var P=Math.max(-1,e[E++]-16);f.volume[v][T]=P}else f.volume[v][T]=-1;0!=(8&O)&&(f.effect[v][T]=e[E++]),0!=(16&O)&&(f.effectParam[v][T]=e[E++]),0==(8&O)&&0!=(16&O)&&(f.effect[v][T]=0)}f.effect[v][T]!=l.NONE&&(f.effect[v][T]=this.parseEffect(f.effect[v][T],f.effectParam[v][T]))}this.patterns.push(f),s+=u+d}for(var h=0;h<this.instrumentCount;h++){var S=new a,g=p.readDWord(e,s);if(S.name=p.readString(e,s+4,22),S.type=e[s+26],S.numSamples=p.readWord(e,s+27),0==S.numSamples)s+=g;else{for(var R=0;96>R;R++)S.sampleKeyMap[R]=e[s+33+R];var _=new i;_.type=e[s+233];var L=e[s+225],M=e[s+227],N=e[s+228],I=e[s+229],b=new i;b.type=e[s+234];for(var A=e[s+226],V=e[s+230],y=e[s+231],k=e[s+232],w=0;12>w;w++)L>w&&_.addPoint(p.readWord(e,s+129+4*w),Math.min(p.readWord(e,s+131+4*w)/64,1),w==M,w==N,w==I),A>w&&b.addPoint(p.readWord(e,s+177+4*w),Math.min(p.readWord(e,s+179+4*w)/64,1),w==V,w==y,w==k);S.volumeEnvelope=_,S.panningEnvelope=b,s+=g;for(var D=0;D<S.numSamples;D++){var C=new o;C.sampleLength=p.readDWord(e,s),C.loopStart=p.readDWord(e,s+4),C.loopLength=p.readDWord(e,s+8),C.volume=e[s+12]/64,C.fineTune=e[s+13]<128?e[s+13]:-((255^e[s+13])+1),C.loopType=C.loopLength>0?3&e[s+14]:o.LoopType.NONE,C.sampleBits=0==(16&e[s+14])?o.Bits.FORMAT_8BIT:o.Bits.FORMAT_16BIT,C.panning=e[s+15]/255,C.basePeriod=e[s+16],C.compression=173==e[s+17]?o.Compression.ADPCM:o.Compression.DELTA,C.name=S.name,C.basePeriod>127&&(C.basePeriod=-(256-C.basePeriod)),C.basePeriod=-C.basePeriod+24,S.samples.push(C),s+=40}for(var D=0;D<S.numSamples;D++){var C=S.samples[D];if(C.sampleLength>0){var x=e.subarray(s,s+C.sampleLength);C.compression===o.Compression.DELTA?C.loadDeltaSample(x):C.loadAdpcmSample(x),s+=C.sampleLength,C.sampleBits===o.Bits.FORMAT_16BIT&&(C.sampleLength/=2,C.loopStart/=2,C.loopLength/=2)}}}this.instruments.push(S)}};h.prototype=Object.create(r.prototype),h.prototype.parseEffect=function(e,t){switch(e){case 0:return l.ARPEGGIO;case 1:return l.PORTA_UP;case 2:return l.PORTA_DOWN;case 3:return l.TONE_PORTA;case 4:return l.VIBRATO;case 5:return l.TONE_PORTA_VOL_SLIDE;case 6:return l.VIBRATO_VOL_SLIDE;case 7:return l.TREMOLO;case 8:return l.SET_PAN;case 9:return l.SAMPLE_OFFSET;case 10:return l.VOLUME_SLIDE;case 11:return l.POSITION_JUMP;case 12:return l.SET_VOLUME;case 13:return l.PATTERN_BREAK;case 14:var s=(240&t)>>4;switch(s){case 1:return l.FINE_PORTA_UP;case 2:return l.FINE_PORTA_DOWN;case 3:return l.SET_GLISANDO;case 4:return l.SET_VIBRATO;case 5:return l.SET_FINETUNE;case 6:return l.SET_LOOP;case 7:return l.SET_TREMOLO;case 9:return l.RETRIGGER;case 10:return l.FINE_VOL_SLIDE_UP;case 11:return l.FINE_VOL_SLIDE_DOWN;case 12:return l.CUT_NOTE;case 13:return l.DELAY_NOTE;case 14:return l.DELAY_PATTERN;default:return l.NONE}case 15:return l.SET_TEMPO_BPM;case 16:return l.SET_GLOBAL_VOLUME;case 17:return l.GLOBAL_VOLUME_SLIDE;case 21:return l.ENVELOPE_POSITION;case 25:return l.PAN_SLIDE;case 27:return l.RETRIG_VOL_SLIDE;case 29:return l.TREMOR;case 33:var s=(240&t)>>4;switch(s){case 1:return l.EXTRA_FINE_PORTA_UP;case 2:return l.EXTRA_FINE_PORTA_DOWN;default:return l.NONE}default:return l.NONE}},t.exports=h},{"./effects":2,"./envelope":3,"./helpers":5,"./instrument":6,"./module":8,"./pattern":9,"./sample":11}]},{},[4]);